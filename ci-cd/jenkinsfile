pipeline {
  agent {
    kubernetes {
      yamlFile './ci-cd/slave-pod.yaml'
    }
  }

  parameters {
    string(name: 'container_name', defaultValue: 'deploy-test-container', description: 'Container name')
    string(name: 'image_name', defaultValue: 'deploy-test', description: 'Image name')
    string(name: 'image_tag', defaultValue: 'latest', description: 'Image tag')
    string(name: 'container_port', defaultValue: '80', description: 'Container port')
  }

  stages {
    stage('install') {
      steps {
        container('composer-container'){
          sh 'cp .env.example .env'
          sh 'composer install --no-interaction'
          sh 'php artisan key:generate'
        }
      }
    }

    stage('tests') {
      steps {
        container('composer-container'){
          sh 'composer tests'
        }
      }
    }

    stage('build') {
      steps {
        container('docker'){
          // build image
          sh 'docker build -t ${image_name}:${image_tag} .'
          // push image to ecr
          sh 'docker push 705505288478.dkr.ecr.sa-east-1.amazonaws.com/ci-deploy-test-registry/${image_name}:${image_tag}'
        }
      }
    }
  }
}



